
// IMPORTANTE:: Led infrarrojo conectado a pin 3

#include <IRremote.h>

#define RECV_PIN  2
#define LED_CALIBRACION 5
#define TRIGGER 9
#define RCV 4

IRrecv irrecv(RECV_PIN);
IRsend irsend;

decode_results results;

int salud=100;



void setup()
{

  pinMode(TRIGGER, INPUT_PULLUP);
  pinMode(RCV, INPUT);
  pinMode(LED_CALIBRACION,OUTPUT);
  
  Serial.begin(9600);
  Serial.println("Listo");
  irrecv.enableIRIn(); // Empezamos la recepción  por IR
}


unsigned long dump(decode_results *results) {
  
  // Call this after IRrecv::decode()
  
  Serial.print("(");
  Serial.print(results->bits, DEC);
  Serial.print(" bits)");
  
  if (results->decode_type == UNKNOWN) {
    Serial.print("Unknown encoding: ");
  }
  else if (results->decode_type == NEC) {
    if (results->value != REPEAT){
    Serial.print("Datos recibidos: ");
    Serial.println(results->value);
    return results->value;
    }
  }

  Serial.print(results->value, HEX);
  Serial.print(" (HEX) , ");
  Serial.print(results->value, BIN);
  Serial.println(" (BIN)");

  return -1;

  

}

void tocado(){

  salud -=random(1, 20);
  if(salud <=0)
    derribado();

}

void derribado()
{
  Serial.println("Derribado");
  
  while(1){
    
  }
  
}

void disparo(){
  
}

void calibracion(){
  analogWrite(LED_CALIBRACION,180);
  delay(200);
  while(digitalRead(TRIGGER))
  {
    irsend.sendNEC(1, 32);
  }
  digitalWrite(LED_CALIBRACION,LOW);
  delay(200);
}

void loop() {
  unsigned long data;
  int ch_trg;
  
  data=0;
  
  if (irrecv.decode(&results)) {
    data=dump(&results); 
    irrecv.resume(); // empezamos una nueva recepción
  }
  /*if(results->value==)
  {
    }
  */
  if(data==1){
    Serial.println("HIT");
    tocado();
  }
  
  if(pulseIn(RCV, HIGH, 25000) > 10000)
  {
    Serial.println("Disparo");
    disparo();
    irsend.sendNEC(1, 32);
  } 
  if(!digitalRead(TRIGGER)){
    Serial.println("Modo calibracion");
    calibracion();
  }
  delay(50);
}
